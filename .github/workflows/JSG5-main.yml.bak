name: JS Group 5 â€“ main workflow

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      save_logs:
        description: "Save test failure logs?"
        required: true
        default: "true"
        type: choice
        options:
          - "true"
          - "false"

env:
  IMAGE_NAME: kanilla/flask_app
  PYTHON_VERSION: "3.11"

jobs:

# -------------------------
#      1. TEST JOB
# -------------------------
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pytest

    - name: Run tests
      id: pytest
      run: |
        mkdir -p test_run_artifacts
        pytest || echo "TEST_FAILED" >> test_run_artifacts/test_status.txt

    - name: Upload logs if tests failed AND logs enabled
      if: contains(steps.pytest.outputs, 'TEST_FAILED') && github.event.inputs.save_logs == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: test_failure_logs
        path: test_run_artifacts/

# -------------------------
#  2. DOCKER BUILD & PUSH
# -------------------------
  docker:
    runs-on: ubuntu-latest
    needs: test
    if: ${{ success() }}  # Only run if tests passed

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Log in to DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build Docker image
      run: |
        docker build -t ${{ env.IMAGE_NAME }}:latest .

    - name: Push Docker image
      run: |
        docker push ${{ env.IMAGE_NAME }}:latest

# -------------------------
#    3. DEPLOY TO AZURE
# -------------------------
  deploy:
    runs-on: ubuntu-latest
    needs: docker

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy container to Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: kh-docker-app
        images: ${{ env.IMAGE_NAME }}:latest
