name: John SandsjÃ¶ Group 5 - main workflow

on:
  # pipeline starts at push
  push:
    branches:
     - main

  #pipeline can be started manually
  workflow_dispatch:
    inputs:
      print_test:
        description: 'True = test artifact will be saved. False = no report generated'
        type: boolean
        required: true
        default: false

env:
  OPEN_API_KEY: ${{ secrets.OPEN_API_KEY }}

jobs:
  test_job:
    name: "Job #1 - Tests"
    #----------------------------------------------------------------------------------
    #----------------------------JOB #1 - TEST RUN ------------------------------------
    #----------------------------------------------------------------------------------
    runs-on: ubuntu-latest
    
    outputs:
      #creating output to steer build and push step
      true_test_result: ${{ steps.set_status.outputs.test_outcome }}
      
    steps:
    - name: Checkout repo code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install pytest and other dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
       
    - name: Run pytest
      id: pytest
      continue-on-error: true
      run: |
        # making sure pytest finds the root and path to weather_app
        export PYTHONPATH=$PYTHONPATH:./ 
        # pytest command finds and execute files starting with 'test_' and save results to a xml file
        pytest > test_report.txt

    - name: Set test status (custom step due to continue-on-error is true)
      id: set_status
      run: |
        # Write the output from pytest step above
        echo "test_outcome=${{ steps.pytest.outcome }}" >> $GITHUB_OUTPUT
    
    - name: Upload pytest report as artifact, as a txt file
      if: ${{ github.event.inputs.print_test == 'true' }}
      uses: actions/upload-artifact@v4
      with:
        name: pytest-test-report
        path: test_report.txt
      
  
  build_and_push_job:
    name: "Job #2 - Build and push docker image to Docker Hub"
    #----------------------------------------------------------------------------------
    #------------------------JOB #2 - Build and Push to Docker Hub --------------------
    #----------------------------------------------------------------------------------
    runs-on: ubuntu-latest
    needs: test_job

    # custom condition so this job runs only if true test success 
    # because of overwritten in continue-on-error is true step
    if: ${{ needs.test_job.outputs.true_test_result == 'success' }}
    
    env:
    #name and path that the final built image in Docker Hub
      DOCKER_IMAGE: johnsandsjo91826/jsg5_weather_app
      DOCKERFILE_PATH: ./dockerfile
      
    steps:
    - name: Checkout repo code
      uses: actions/checkout@v4
    
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    

    - name: Build and Push Docker Image
    # This step performs the actual build and push operation.
      uses: docker/build-push-action@v5
      with:
        context: . # Path to where dockerfile is (build context)
        file: ${{ env.DOCKERFILE_PATH }}
        push: true # flag to tell the action to push the image to Docker Hub
        tags: ${{ env.DOCKER_IMAGE }}:latest #hard coded latest tag for simplicity

        