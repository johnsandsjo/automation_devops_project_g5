name: John Sandsj√∂ Group 5 - main workflow

#pipeline starts at push
on:
  push:
    branches:
      - main

  #pipeline can be started manually
  workflow_dispatch:
    inputs:
      print_test:
        description: 'If true, failed tests will be saved to a log file. If false, no report generated'
        type: boolean
        required: true
        default: false

env:
  OPEN_ssssAPI_KEY: ${{ secrets.OPEN_API_KEY }}

jobs:
  test_job:
    name: "Job #1 - Tests"
  #----------------------------------------------------------------------------------
  #----------------------------JOB #1 - TEST RUN ------------------------------------
  #----------------------------------------------------------------------------------
    runs-on: ubuntu-latest
    
    outputs:
        pytest_outcome: ${{ steps.outcome }}
        
    steps:
    - name: Checkout repo code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install pytest and other dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
       
    - name: Run pytest
      id: test
      continue-on-error: true
      run: |
        # making sure pytest finds the root and path to weather_app
        export PYTHONPATH=$PYTHONPATH:./ 
        # pytest command finds and execute files starting with 'test_' and save results to a xml file
        pytest --junitxml=reporty.xml

    - name: Print test result
      if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.print_test == 'true' && steps.test.outcome == 'failure' }}
      run: |
        echo "Test failed, generating report"
        # creating folder for reports (idempotent with -p)
        mkdir -p test_reports_dir 
        # moving the file to the folder
        if [ -f reporty.xml ]; then
          mv reporty.xml test_reports_dir/
        else
          echo "reporty.xml not found."
        fi
    
    - name: Upload pytest report as artifact
      if: ${{ steps.test.outcome == 'failure' && github.event.inputs.print_test == 'true' }}
      uses: actions/upload-artifact@v4
      with:
        name: pytest-test-report # The name you'll see on the GitHub Actions summary page
        path: failed_reports_dir/reporty.xml         # The path to the file you want to upload


  build_and_push_job:
    name: "Job #2 - Build and push docker image to Docker Hub"
    #----------------------------------------------------------------------------------
    #------------------------JOB #2 - Build and Push to Docker Hub --------------------
    #----------------------------------------------------------------------------------
    runs-on: ubuntu-latest
    needs: test_job
    
    env:
    #name and path that the final built image in Docker Hub
      DOCKER_IMAGE: johnsandsjo91826/jsg5_weather_app
      DOCKERFILE_PATH: ./dockerfile

    steps:
    - name: Checkout repo code
      uses: actions/checkout@v4
    
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Extract metadata (tags, labels) for Docker
      id: metadata
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.DOCKER_IMAGE }}

    - name: Build and Push Docker Image
    # This step performs the actual build and push operation.
      uses: docker/build-push-action@v5
      with:
        context: . # Path to where dockerfile is (build context)
        file: ${{ env.DOCKERFILE_PATH }}
        push: true # flag to tell the action to push the image to Docker Hub
        tags: ${{ steps.metadata.outputs.tags }}
        labels: ${{ steps.metadata.outputs.labels }}